---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: grafana-dashboard-backup
spec:
  schedule: "0 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: grafana-backup
            image: registry.gitlab.com/gitlab-ci-utils/curl-jq:latest
            command:
              - /bin/sh
              - /scripts/backup.sh
            securityContext:
              runAsUser: 10001
              runAsGroup: 10001
              runAsNonRoot: true
              readOnlyRootFilesystem: true
              privileged: false
              allowPrivilegeEscalation: false
              seccompProfile: 
                type: RuntimeDefault
              capabilities:
                drop:
                - ALL
            volumeMounts:
              - mountPath: /workspace
                name: workspace
              - mountPath: /scripts/backup.sh
                name: backup-script
                readOnly: true
            workingDir: /workspace
            env:
              - name: BACKUP_DASHBOARD_TAG
                value: backup
              - name: BACKUP_GRAFANA_URL
                value: http://kube-prometheus-stack-grafana.infra-observability:80
              - name: BACKUP_GIT_REPO
                value: ${grafanaDashboardBackupGitRepo}
            envFrom:
              - secretRef:
                  name: grafana-backup-service-account
              - secretRef:
                  name: grafana-backup-git-access-token
          restartPolicy: OnFailure
          automountServiceAccountToken: false
          volumes:
            - name: workspace
              emptyDir: {}
            - name: backup-script
              projected:
                defaultMode: 0770
                sources:
                - configMap:
                    name: backup-script

