---
apiVersion: v1
kind: Secret
metadata:
  name: discord-webhook-url
  namespace: infra-observability
type: Opaque
stringData:
  address: ${discordAlertmanagerAddress}
---
# https://blog.ediri.io/how-to-set-up-a-dead-mans-switch-in-prometheus
apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: ${clusterName}
  namespace: infra-observability
  labels:
    alertmanager: ${clusterName}
spec:
  route:
    receiver: "null"
    routes:
      - receiver: healthchecks
        matchers:
        - name: alertname
          matchType: "="
          value: Watchdog
        groupBy:
        - cluster
        groupWait: 0s
        groupInterval: 0s
        repeatInterval: 24h
        continue: false
      - receiver: discord
        matchers:
        - name: alertname
          matchType: "=~"
          value: ".+"
        groupBy:
        - alertname
        - cluster
        - job
        groupWait: 5m
        groupInterval: 10m
        repeatInterval: 24h
  receivers:
  - name: discord
    discordConfigs:
    - apiURL:
        name: discord-webhook-url
        key: address
  - name: healthchecks
    webhookConfigs:
    - url: ${watchdogAlertUrl}